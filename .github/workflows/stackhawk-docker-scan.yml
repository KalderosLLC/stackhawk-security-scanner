name: StackHawk Weekly Security Scans (Docker)

on:
  schedule:
    # Run weekly Monday at 10:00 AM (UTC)
    - cron: '0 10 * * 1'
  workflow_dispatch:
    # Allow manual triggering

jobs:
  stackhawk-bulk-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2 hours timeout for all scans
    
    steps:
    - name: üîç Checkout repository
      uses: actions/checkout@v4
      
    - name: üê≥ Pull StackHawk Docker image
      run: |
        echo "ü¶Ö Pulling StackHawk Docker image..."
        docker pull stackhawk/hawkscan:latest
        
    - name: üöÄ Run bulk security scans
      env:
        HAWK_API_KEY: ${{ secrets.HAWK_API_KEY }}
      run: |
        echo "ü¶Ö Starting StackHawk bulk security scans..."
        chmod +x ./scan-runner-actions.sh
        chmod +x ./bulk-scan-runner.sh
        
        # Test single scan first to check for obvious issues
        echo "üß™ Testing single scan first..."
        ./scan-runner-actions.sh list
        
        # Get first config file for test
        FIRST_CONFIG=$(ls stackhawk-*.yml | head -1)
        if [ -n "$FIRST_CONFIG" ]; then
            echo "üîç Testing with: $FIRST_CONFIG"
            APP_NAME="${FIRST_CONFIG%.yml}"
            APP_NAME="${APP_NAME#stackhawk-}"
            
            echo "üöÄ Running test scan for $APP_NAME..."
            if ./scan-runner-actions.sh "$APP_NAME"; then
                echo "‚úÖ Test scan successful, proceeding with bulk scan..."
                ./bulk-scan-runner.sh
            else
                echo "‚ùå Test scan failed, checking common issues..."
                echo "ÔøΩ Configuration file contents:"
                head -20 "$FIRST_CONFIG"
                echo ""
                echo "ÔøΩ API Key status: ${HAWK_API_KEY:+SET (length: ${#HAWK_API_KEY})}${HAWK_API_KEY:-NOT SET}"
                exit 1
            fi
        else
            echo "‚ùå No configuration files found"
            exit 1
        fi
        
    - name: üìä Upload scan results
      uses: actions/upload-artifact@v4
      if: always()  # Upload results even if scans fail
      with:
        name: stackhawk-scan-results-${{ github.run_number }}
        path: bulk-scan-results-*.log
        retention-days: 30
